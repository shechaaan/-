<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Travel Log</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body>

<h1>âœˆï¸ Travel Log</h1>

<h2>æ—…è¡Œã‚’è¨˜éŒ²</h2>

<input id="place" placeholder="å ´æ‰€">
<input id="date" type="date">
<input id="memo" placeholder="ãƒ¡ãƒ¢">
<input id="rating" type="number" min="1" max="5" placeholder="è©•ä¾¡(1ã€œ5)">
<input type="file" id="photo">

<p>ğŸ‘‰ åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨åº§æ¨™ãŒå…¥ã‚Šã¾ã™</p>
<input id="lat" placeholder="ç·¯åº¦">
<input id="lng" placeholder="çµŒåº¦">

<button onclick="addTrip()">è¿½åŠ </button>

<h2>è¨˜éŒ²ä¸€è¦§</h2>
<div id="tripList"></div>

<h2>æ€ã„å‡ºãƒãƒƒãƒ—</h2>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="script.js"></script>
  body {
  font-family: sans-serif;
  margin: 20px;
}

#map {
  height: 400px;
  margin-top: 20px;
}

.trip-card {
  border: 1px solid #ccc;
  padding: 10px;
  margin: 10px 0;
}

img {
  width: 100px;
  margin-top: 5px;
}
let trips = JSON.parse(localStorage.getItem("trips")) || [];
let editIndex = null;

function saveTrips() {
  localStorage.setItem("trips", JSON.stringify(trips));
}

// ğŸ“åœ°å›³
let map = L.map('map').setView([35, 135], 5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
.addTo(map);

// åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§åº§æ¨™å…¥åŠ›
map.on('click', function(e) {
  document.getElementById("lat").value = e.latlng.lat.toFixed(4);
  document.getElementById("lng").value = e.latlng.lng.toFixed(4);
});

let markers = [];

// â­è©•ä¾¡ã§è‰²å¤‰æ›´
function getColor(rating){
  if(rating >= 4) return "green";
  if(rating == 3) return "orange";
  return "red";
}

// ğŸ“¸ç”»åƒã‚’Base64ä¿å­˜
function getPhoto(callback){
  let file = document.getElementById("photo").files[0];
  if(!file){
    callback(null);
    return;
  }
  let reader = new FileReader();
  reader.onload = () => callback(reader.result);
  reader.readAsDataURL(file);
}

// è¿½åŠ  or ç·¨é›†
function addTrip(){

  getPhoto(photoData => {

    const trip = {
      place: place.value,
      date: date.value,
      memo: memo.value,
      rating: parseInt(rating.value),
      lat: parseFloat(lat.value),
      lng: parseFloat(lng.value),
      photo: photoData
    };

    if(editIndex !== null){
      trips[editIndex] = trip;
      editIndex = null;
    } else {
      trips.push(trip);
    }

    saveTrips();
    displayTrips();
    displayMap();
  });
}

// ä¸€è¦§è¡¨ç¤º
function displayTrips(){
  tripList.innerHTML = "";

  trips.forEach((t,i) => {

    let stars = "â­".repeat(t.rating);

    tripList.innerHTML += `
      <div class="trip-card">
        <b>${t.place}</b><br>
        ğŸ“… ${t.date}<br>
        ğŸ“ ${t.memo}<br>
        ${stars}<br>
        ${t.photo ? `<img src="${t.photo}">` : ""}

        <br>
        <button onclick="editTrip(${i})">ç·¨é›†</button>
        <button onclick="deleteTrip(${i})">å‰Šé™¤</button>
      </div>
    `;
  });
}

// ç·¨é›†
function editTrip(i){
  let t = trips[i];
  place.value = t.place;
  date.value = t.date;
  memo.value = t.memo;
  rating.value = t.rating;
  lat.value = t.lat;
  lng.value = t.lng;
  editIndex = i;
}

// å‰Šé™¤
function deleteTrip(i){
  trips.splice(i,1);
  saveTrips();
  displayTrips();
  displayMap();
}

// ãƒãƒƒãƒ—è¡¨ç¤º
function displayMap(){

  markers.forEach(m => map.removeLayer(m));
  markers = [];

  trips.forEach(t => {

    if(t.lat && t.lng){

      let stars = "â­".repeat(t.rating);

      let popup = `
        <b>ğŸ“ ${t.place}</b><br>
        ğŸ“… ${t.date}<br>
        ğŸ“ ${t.memo}<br>
        ${stars}<br>
        ${t.photo ? `<img src="${t.photo}" width="120">` : ""}
      `;

      let marker = L.circleMarker(
        [t.lat, t.lng],
        { color: getColor(t.rating), radius: 8 }
      )
      .addTo(map)
      .bindPopup(popup);

      markers.push(marker);
    }
  });
}

displayTrips();
displayMap();


</body>
</html>
